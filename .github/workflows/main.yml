name: macOS VNC (Tailscale + ARD Legacy)

on:
  workflow_dispatch:

jobs:
  macos-vnc:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      # -------------------------------
      # 0) Generate passwords
      # -------------------------------
      - name: Generate VNC Passwords
        run: |
          # 16-char random; LEGACY VNC hanya pakai 8 char pertama
          p=$(openssl rand -base64 12 | tr -d '/+=' | cut -c1-16)
          echo "VNC_PASSWORD_FULL=$p" >> $GITHUB_ENV
          echo "VNC_PASSWORD_LEGACY=${p:0:8}" >> $GITHUB_ENV

          echo "✓ Legacy VNC password (use in viewer): ${p:0:8}"
          echo "ℹ️  Password user 'runner' TIDAK diubah."

      # -------------------------------
      # 1) Tailscale
      # -------------------------------
      - name: Install & Connect Tailscale
        run: |
          echo "Installing Tailscale..."
          brew install tailscale

          echo "Starting Tailscale daemon..."
          sudo brew services start tailscale || true
          sleep 8

          echo "Connecting to Tailscale..."
          sudo tailscale up \
            --authkey='${{ secrets.TAILSCALE_AUTH_KEY }}' \
            --hostname="gh-mac-${{ github.run_id }}" \
            --accept-routes

          echo "✓ Tailscale connected"

      - name: Get Tailscale IP
        run: |
          retries=0
          while [ $retries -lt 20 ]; do
            TSIP=$(sudo tailscale ip -4 2>/dev/null | head -n1 || true)
            if [ -n "$TSIP" ]; then
              echo "TAILSCALE_IP=$TSIP" >> $GITHUB_ENV
              echo "✓ Tailscale IP: $TSIP"
              break
            fi
            echo "⏳ Waiting for IP... $((retries + 1))/20"
            sleep 3
            retries=$((retries + 1))
          done

          if [ -z "$TSIP" ]; then
            echo "❌ Failed to get Tailscale IP"
            exit 1
          fi

      # -------------------------------
      # 2) Enable ARD/ScreenSharing + Legacy VNC
      # -------------------------------
      - name: Enable Remote Management & Legacy VNC
        run: |
          set -e
          KS="/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart"

          echo "Enabling Remote Management (Screen Sharing)..."
          sudo "$KS" -activate

          # Izinkan akses untuk semua user lokal (kita tidak mengubah password 'runner').
          sudo "$KS" -configure -allowAccessFor -allUsers
          sudo "$KS" -configure -access -on -privs -all

          # Aktifkan legacy VNC + set password (maks 8 char)
          LEGACY="${VNC_PASSWORD_LEGACY}"
          echo "Configuring LEGACY VNC password (8 chars)..."
          sudo "$KS" \
            -configure -clientopts -setvnclegacy -vnclegacy yes \
            -configure -clientopts -setvncpw -vncpw "$LEGACY"

          # Pastikan daemon screensharing aktif
          sudo launchctl enable system/com.apple.screensharing || true
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true

          # Restart agent supaya setting ter-apply
          sudo "$KS" -restart -agent -console

          echo "✓ Remote Management & legacy VNC configured."

      # -------------------------------
      # 3) Force GUI session for 'runner' (hindari black screen)
      # -------------------------------
      - name: Force GUI Session (runner)
        run: |
          set -e
          USERNAME="runner"
          RUN_UID=$(id -u "$USERNAME")
          echo "Bootstrapping GUI for $USERNAME (uid=$RUN_UID)..."

          # Bootstrap GUI domain (Aqua) untuk user headless
          sudo launchctl bootstrap "gui/$RUN_UID" /System/Library/LaunchAgents 2>/dev/null || true

          # Start komponen desktop inti
          sudo launchctl asuser "$RUN_UID" /usr/bin/open -a /System/Library/CoreServices/Finder.app || true
          sudo launchctl asuser "$RUN_UID" /usr/bin/open -a /System/Library/CoreServices/Dock.app || true
          sudo launchctl asuser "$RUN_UID" /usr/bin/open -a /System/Library/CoreServices/SystemUIServer.app || true

          # Nudge desktop (opsional) + buka TextEdit biar kelihatan
          sudo launchctl asuser "$RUN_UID" /usr/bin/osascript -e 'tell application "Finder" to activate' 2>/dev/null || true
          sudo launchctl asuser "$RUN_UID" /usr/bin/open -a /System/Applications/TextEdit.app || true

          echo "Waiting 12s for GUI to settle..."
          sleep 12

      # -------------------------------
      # 4) Verify
      # -------------------------------
      - name: Verify Screen Sharing & VNC
        run: |
          echo "Checking VNC port (5900)..."
          (netstat -an 2>/dev/null | grep -E '(^|\.)5900[^0-9]') || echo "Warning: Port 5900 not listening yet"

          echo "--- Processes ---"
          ps aux | grep -i -E 'screensharing|ARDAgent|RemoteManagement|WindowServer|TextEdit' | grep -v grep || true

          echo "--- ARD Status ---"
          /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -status || true

          echo "--- (If needed) restart screensharing agent ---"
          sudo launchctl kickstart -kp system/com.apple.screensharing 2>/dev/null || true

      # -------------------------------
      # 5) Connection info + keepalive
      # -------------------------------
      - name: Connection Info & Keep Alive
        run: |
          echo ""
          echo "=============================================="
          echo "         macOS VNC CONNECTION INFO"
          echo "=============================================="
          echo "Address (Tailscale): $TAILSCALE_IP:5900"
          echo ""
          echo "Use this (LEGACY VNC - 1 password field):"
          echo "  Password: $VNC_PASSWORD_LEGACY   (8 chars)"
          echo ""
          echo "Catatan:"
          echo "- Password user 'runner' TIDAK diubah."
          echo "- Mayoritas VNC viewer umum hanya tanya 1 field password => gunakan legacy di atas."
          echo "- Jika pakai Apple Screen Sharing dari Mac lain (vnc://$TAILSCALE_IP),"
          echo "  bisa coba login sebagai 'runner' + password yang memang sudah ada (kalau kamu tahu)."
          echo "=============================================="
          echo ""

          # Keep GUI/session alive selama job berjalan
          USERNAME="runner"
          RUN_UID=$(id -u "$USERNAME")

          while true; do
            echo "[$(date)] macOS VNC Active"
            caffeinate -u -t 2 >/dev/null 2>&1 &

            # Jaga komponen desktop untuk user runner
            pgrep -x Finder >/dev/null || sudo launchctl asuser "$RUN_UID" /usr/bin/open -a /System/Library/CoreServices/Finder.app >/dev/null 2>&1 || true
            pgrep -x Dock   >/dev/null || sudo launchctl asuser "$RUN_UID" /usr/bin/open -a /System/Library/CoreServices/Dock.app   >/dev/null 2>&1 || true

            sleep 300
          done
