- name: Configure VNC & launch Xtigervnc directly (no wrapper)
        shell: bash
        env:
          VNC_PASS_INPUT: ${{ github.event.inputs.VNC_PASS }}
          GEOM: ${{ github.event.inputs.GEOMETRY }}
        run: |
          set -euo pipefail

          # ---- 1) Password VNC ----
          if [ -n "${VNC_PASS_INPUT:-}" ]; then
            VNC_PASS="$VNC_PASS_INPUT"
          else
            VNC_PASS="$(LC_ALL=C tr -dc 'A-Za-z0-9' </dev/urandom | head -c8)"
            echo "::notice::Generated VNC password: ${VNC_PASS}"
          fi
          echo "VNC_PASS=$VNC_PASS" >> "$GITHUB_ENV"

          mkdir -p "$HOME/.vnc"
          if command -v vncpasswd >/dev/null 2>&1; then
            printf "%s\n" "$VNC_PASS" | vncpasswd -f > "$HOME/.vnc/passwd"
          else
            printf "%s\n" "$VNC_PASS" | /opt/homebrew/bin/vncpasswd -f > "$HOME/.vnc/passwd"
          fi
          chmod 600 "$HOME/.vnc/passwd"

          # ---- 2) Temukan Xtigervnc ----
          XTIGERVNC="$(command -v Xtigervnc || true)"
          if [ -z "$XTIGERVNC" ]; then
            # coba path brew
            for p in /opt/homebrew/bin/Xtigervnc /usr/local/bin/Xtigervnc $(brew --prefix 2>/dev/null)/bin/Xtigervnc; do
              [ -x "$p" ] && XTIGERVNC="$p" && break
            done
          fi
          if [ -z "$XTIGERVNC" ]; then
            echo "Xtigervnc not found. Check TigerVNC install step." >&2
            exit 1
          fi
          echo "Using Xtigervnc at: $XTIGERVNC"

          # ---- 3) Matikan instance lama jika ada ----
          pkill -f Xtigervnc || true
          pkill -f Xvnc || true

          # ---- 4) Start Xtigervnc on display :1, port 5900 ----
          GEOM="${GEOM:-1920x1080}"
          LOG_VNC="/tmp/vncserver.log"
          nohup "$XTIGERVNC" :1 \
            -geometry "$GEOM" \
            -desktop "GHA VNC" \
            -rfbport 5900 \
            -localhost no \
            -SecurityTypes VncAuth \
            -rfbauth "$HOME/.vnc/passwd" \
            -AlwaysShared=1 \
            -IdleTimeout=0 \
            -MaxDisconnectionTime=0 \
            -MaxConnectionTime=0 \
            > "$LOG_VNC" 2>&1 &

          # Tunggu listening
          for i in $(seq 1 15); do
            sleep 1
            if lsof -iTCP:5900 -sTCP:LISTEN >/dev/null 2>&1; then
              break
            fi
          done
          echo "===== $LOG_VNC (tail) ====="
          tail -n 50 "$LOG_VNC" || true
          echo "==========================="

          # ---- 5) Launch xterm ke display :1 (biar ada window) ----
          if command -v xterm >/dev/null 2>&1; then
            ( DISPLAY=:1 nohup xterm >/tmp/xterm.log 2>&1 & ) || true
          fi

          echo "VNC_PORT=5900" >> "$GITHUB_ENV"
