name: macOS VNC

on:
  workflow_dispatch:

jobs:
  macos-vnc:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Generate VNC Password
        run: |
          # Random 16-char (huruf+angka), tanpa /+=
          password=$(openssl rand -base64 12 | tr -d '/+=' | cut -c1-16)
          echo "VNC_PASSWORD=$password" >> $GITHUB_ENV
          echo "✓ User password (16): $password"

          # Legacy VNC pass = max 8 char (VNC protocol lawas)
          echo "VNC_PASSWORD_LEGACY=${password:0:8}" >> $GITHUB_ENV
          echo "✓ Legacy VNC password (8): ${password:0:8}"

          # Username khusus VNC (jangan ubah 'runner')
          echo "VNC_USER=vncuser" >> $GITHUB_ENV

      - name: Install Tailscale
        run: |
          echo "Installing Tailscale..."
          brew install tailscale
          
          echo "Starting Tailscale daemon..."
          sudo brew services start tailscale || true
          sleep 8
          
          echo "Connecting to Tailscale..."
          sudo tailscale up \
            --authkey='${{ secrets.TAILSCALE_AUTH_KEY }}' \
            --hostname="gh-mac-${{ github.run_id }}" \
            --accept-routes
          
          echo "✓ Tailscale connected"

      - name: Get Tailscale IP
        run: |
          sleep 3
          retries=0
          while [ $retries -lt 20 ]; do
            TSIP=$(sudo tailscale ip -4 2>/dev/null | head -n1 || true)
            if [ -n "$TSIP" ]; then
              echo "TAILSCALE_IP=$TSIP" >> $GITHUB_ENV
              echo "✓ Tailscale IP: $TSIP"
              break
            fi
            echo "⏳ Waiting for IP... $((retries + 1))/20"
            sleep 3
            retries=$((retries + 1))
          done
          
          if [ -z "$TSIP" ]; then
            echo "❌ Failed to get Tailscale IP"
            exit 1
          fi

      - name: Create Dedicated Admin User for VNC
        run: |
          set -e
          echo "Creating user '$VNC_USER'..."
          # Buat user admin baru (punya home dir), password = $VNC_PASSWORD
          # sysadminctl sudah include pembuatan homedir; tambahkan -admin agar punya hak admin
          sudo sysadminctl -addUser "$VNC_USER" -password "$VNC_PASSWORD" -admin

          # Pastikan home dibuat (fallback untuk versi tertentu)
          sudo createhomedir -c -u "$VNC_USER" >/dev/null 2>&1 || true

          # Tambahkan ke group 'screensharing' kalau ada (biasanya tidak wajib jika pakai ARD)
          if dscl . -read /Groups/screensharing >/dev/null 2>&1; then
            sudo dseditgroup -o edit -a "$VNC_USER" -t user screensharing || true
          fi

          echo "✓ User '$VNC_USER' created and ready."

      - name: Enable Remote Management & Configure Access
        run: |
          echo "Enabling Remote Management (Apple Screen Sharing)..."
          KS="/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart"

          # Aktifkan layanan
          sudo "$KS" -activate

          # Izinkan hanya user tertentu (vncuser) & beri semua privileges
          sudo "$KS" -configure -allowAccessFor -specifiedUsers
          sudo "$KS" -configure -access -on -privs -all -users "$VNC_USER"

          # Aktifkan screensharing daemon
          sudo launchctl enable system/com.apple.screensharing || true
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true

          # Set LEGACY VNC password (8 char) supaya kompatibel dengan viewer VNC umum
          LEGACY="${VNC_PASSWORD_LEGACY}"
          echo "Configuring legacy VNC password (8 chars)..."
          sudo "$KS" \
            -configure -clientopts -setvnclegacy -vnclegacy yes \
            -configure -clientopts -setvncpw -vncpw "$LEGACY"

          # Restart agent supaya setting ter-apply
          sudo "$KS" -restart -agent -console

          echo "✓ Remote Management & VNC configured."

          echo "Waiting 15s for services to settle..."
          sleep 15

      - name: Verify VNC Port
        run: |
          echo "Checking VNC accessibility..."
          (netstat -an 2>/dev/null | grep -E '(^|\.)5900[^0-9]' ) || echo "Warning: Port 5900 not listening yet"
          ps aux | grep -i -E 'screensharing|ARDAgent|RemoteManagement' | grep -v grep || true
          /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -status || true

      - name: Display Connection Info & Keep Alive
        run: |
          echo ""
          echo "================================"
          echo "   macOS VNC CONNECTION INFO"
          echo "================================"
          echo "Address (Tailscale): $TAILSCALE_IP:5900"
          echo ""
          echo "Mode A) Legacy VNC (umum, 1 kolom password):"
          echo "   Password: $VNC_PASSWORD_LEGACY    (8 char)"
          echo ""
          echo "Mode B) Apple Screen Sharing (username+password):"
          echo "   Username: $VNC_USER"
          echo "   Password: $VNC_PASSWORD           (16 char)"
          echo "   URL (dari Mac lain): vnc://$TAILSCALE_IP"
          echo "================================"
          echo ""
          echo "TROUBLESHOOTING:"
          echo "- Kalau viewer hanya minta 1 field password, pakai Mode A (legacy 8-char)."
          echo "- Kalau viewer support macOS login: pakai Mode B (username+password)."
          echo "- Kalau layar hitam: tunggu 30-60 detik atau reconnect."
          echo "- Pastikan konek via Tailscale ke $TAILSCALE_IP:5900."
          echo ""

          # Keep GUI/session alive
          while true; do
            echo "[$(date)] macOS VNC Active"
            caffeinate -u -t 2 >/dev/null 2>&1 &
            # Restart Finder jika crash (optional)
            if ! pgrep -x Finder >/dev/null 2>&1; then
              echo "Restarting Finder..."
              sudo launchctl asuser "$(id -u "$VNC_USER")" /usr/bin/open -a /System/Library/CoreServices/Finder.app >/dev/null 2>&1 || true
            fi
            sleep 300
          done
