name: VNC + Tailscale (macOS, no-hang)

on:
  workflow_dispatch:

jobs:
  setup-remote:
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      - name: Enable Screen Sharing (VNC)
        shell: bash
        run: |
          echo "== Enable VNC / Remote Management =="
          sudo systemsetup -setremotelogin on || true
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw Asukoe123456 \
            -restart -agent -privs -all
          echo "VNC password: Asukoe123456"
          echo

      - name: Install latest Tailscale .pkg (not App Store)
        shell: bash
        run: |
          set -euo pipefail
          STABLE_INDEX="https://pkgs.tailscale.com/stable/"
          echo "== Resolve latest Tailscale macOS pkg from index =="
          PKG_NAME="$(curl -fsSL "$STABLE_INDEX" | grep -o 'Tailscale-[0-9.]*-macos\.pkg' | sort -Vr | head -n1)"
          [[ -z "${PKG_NAME:-}" ]] && { echo "ERROR: gagal menemukan pkg Tailscale"; exit 1; }
          URL="${STABLE_INDEX}${PKG_NAME}"
          echo "Downloading ${URL} ..."
          curl -fsSL -o "${PKG_NAME}" "${URL}"

          echo "Installing ${PKG_NAME} ..."
          sudo installer -pkg "${PKG_NAME}" -target /

          TS_APP="/Applications/Tailscale.app"
          TS_BIN="${TS_APP}/Contents/MacOS/Tailscale"
          [[ -x "$TS_BIN" ]] || { echo "ERROR: ${TS_BIN} tidak ditemukan"; exit 1; }
          "$TS_BIN" version || true
          echo "TS_BIN=${TS_BIN}" >> "$GITHUB_ENV"
          echo

      # OPSI A (aman): skip buka app sama sekali, langsung up
      # Jika kamu tetap ingin "wake" app-nya, pakai OPSI B di bawah dan hapus step ini.
      - name: Bring up Tailscale (unattended, timeout, verbose)
        shell: bash
        run: |
          set -euo pipefail
          TS_BIN="${TS_BIN:-/Applications/Tailscale.app/Contents/MacOS/Tailscale}"
          HOST="macos-runner-${GITHUB_RUN_ID}"

          echo "== tailscale up (no GUI, unattended) =="
          sudo "$TS_BIN" up \
            --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" \
            --hostname="${HOST}" \
            --unattended \
            --accept-dns=false \
            --accept-routes=false \
            --ssh \
            --timeout=60s || {
              echo "tailscale up gagal/timeout"
              echo "-- status --"; sudo "$TS_BIN" status || true
              echo "-- netcheck --"; sudo "$TS_BIN" netcheck || true
              exit 1
            }

          echo
          echo "== Polling IPv4 (max ~3 minutes) =="
          tries=0
          TS_IP=""
          while [[ $tries -lt 36 ]]; do
            TS_IP="$(sudo "$TS_BIN" ip -4 | head -n1 || true)"
            [[ -n "$TS_IP" ]] && { echo "Tailscale IP: ${TS_IP}"; break; }
            tries=$((tries+1))
            echo "No IP yet... (${tries}/36) wait 5s"
            sleep 5
          done
          [[ -z "$TS_IP" ]] && { echo "ERROR: gak dapet IP Tailscale dalam 3 menit"; sudo "$TS_BIN" status || true; exit 1; }
          echo "TAILSCALE_IP=${TS_IP}" >> "$GITHUB_ENV"

      # OPSI B (kalau tetap mau "open" app tanpa hang):
      # - name: (Optional) Background-launch Tailscale app
      #   shell: bash
      #   run: |
      #     TS_APP="/Applications/Tailscale.app"
      #     echo "Background opening Tailscale..."
      #     (open -gj -a "$TS_APP" >/dev/null 2>&1 & disown) || true
      #     sleep 2

      - name: Verify VNC port (5900) is listening
        shell: bash
        run: |
          echo "== Check VNC listen on 5900 =="
          (sudo lsof -nP -iTCP:5900 -sTCP:LISTEN || true)
          echo "Done."
          echo

      - name: Show connection info & keep alive
        shell: bash
        timeout-minutes: 360
        run: |
          echo ""
          echo "=== VNC ACCESS ==="
          echo "Address : $TAILSCALE_IP"
          echo "Password: Asukoe123456"
          echo "=================="
          echo ""
          echo "Android: pakai VNC Viewer/bVNC, connect ke $TAILSCALE_IP:5900"
          echo ""
          while true; do
            echo "[$(date)] VNC aktif - Cancel workflow untuk stop"
            sleep 300
          done
