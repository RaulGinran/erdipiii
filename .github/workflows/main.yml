name: macOSTailscale + native VNC (Screen Sharing)

on:
  workflow_dispatch:
    inputs:
      VNC_PASS:
        description: "Opsional: VNC password (maks 8 char). Kalau kosong akan digenerate & ditampilkan."
        required: false
        default: ""

jobs:
  macos-remote:
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      - name: Info
        shell: bash
        run: |
          sw_vers
          echo "User: $(whoami)"
          echo "Home: $HOME"

      - name: Install Tailscale via Homebrew
        shell: bash
        run: |
          if ! command -v brew >/dev/null 2>&1; then
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi
          eval "$(/opt/homebrew/bin/brew shellenv 2>/dev/null || true)"
          eval "$(/usr/local/bin/brew shellenv 2>/dev/null || true)"
          brew update
          brew install tailscale || brew upgrade tailscale || true
          tailscale version || true

      - name: Start tailscaled & connect
        shell: bash
        env:
          TS_AUTH: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          set -euo pipefail
          if [ -z "${TS_AUTH:-}" ]; then
            echo "Missing secret: TAILSCALE_AUTH_KEY" >&2; exit 1
          fi
          sudo nohup tailscaled --tun=userspace-networking > /tmp/tailscaled.log 2>&1 &
          for i in $(seq 1 20); do
            tailscale status >/dev/null 2>&1 && break || sleep 1
          done
          HOST="gha-macos-${GITHUB_RUN_ID}"
          sudo tailscale up --authkey="${TS_AUTH}" --hostname="${HOST}" --accept-routes --accept-dns || \
          sudo tailscale up --authkey="${TS_AUTH}" --hostname="${HOST}"
          ip4="$(tailscale ip -4 | awk '/^ *100\./{print $1;exit}')"
          if [ -z "$ip4" ]; then
            echo "No Tailscale IPv4 yet"; tailscale status || true; tail -n 100 /tmp/tailscaled.log || true; exit 1
          fi
          echo "TAILSCALE_IP=$ip4" >> "$GITHUB_ENV"
          echo "Tailscale IP: $ip4"

      - name: Enable macOS Screen Sharing (VNC) for current user
        shell: bash
        env:
          VNC_PASS_INPUT: ${{ github.event.inputs.VNC_PASS }}
        run: |
          set -euo pipefail

          # --- password: pakai input kalau ada; kalau kosong generate 8 char & TAMPILKAN ---
          if [ -n "${VNC_PASS_INPUT:-}" ]; then
            VNC_PASS="$VNC_PASS_INPUT"
          else
            VNC_PASS="$(LC_ALL=C tr -dc 'A-Za-z0-9' </dev/urandom | head -c8)"
            echo "::notice::Generated VNC password: ${VNC_PASS}"
          fi
          VNC_PASS="${VNC_PASS:0:8}"   # batas 8

          CURUSER="$(whoami)"
          echo "VNC will allow user: $CURUSER"

          KICK="/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart"

          # Aktifkan ARD / Screen Sharing + legacy VNC password
          sudo "$KICK" -activate
          sudo "$KICK" -configure -access -on
          sudo "$KICK" -configure -clientopts -setvnclegacy -vnclegacy yes
          sudo "$KICK" -configure -setvncpw -vncpw "$VNC_PASS"

          # Beri semua priv ke user 'runner' (atau user saat ini)
          sudo "$KICK" -configure -users "$CURUSER" -privs -all
          sudo "$KICK" -restart -agent

          # Pastikan service screensharingd aktif
          sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true
          sudo launchctl load  -w /System/Library/LaunchDaemons/com.apple.screensharing.plist

          # (opsional) SSH
          sudo systemsetup -setremotelogin on

          # simpan pw utk step terakhir
          echo "VNC_PASS=$VNC_PASS" >> "$GITHUB_ENV"

      - name: Info koneksi & keep alive
        shell: bash
        timeout-minutes: 360
        run: |
          echo ""
          echo "=== CONNECTION INFO ==="
          echo "Tailscale IP : ${TAILSCALE_IP}"
          echo "VNC address  : ${TAILSCALE_IP}:5900"
          echo "User (ScreenSharing): $(whoami)"
          echo "VNC password : ${VNC_PASS}"
          echo "tailscaled log: /tmp/tailscaled.log"
          echo "======================="
          echo ""
          while true; do
            date
            tailscale status | head -n 20 || true
            sudo launchctl list | grep -i screensharing || true
            sleep 300
          done
