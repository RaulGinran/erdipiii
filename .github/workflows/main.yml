name: macOS VNC Access via Tailscale

on:
  workflow_dispatch:

jobs:
  macos-vnc:
    runs-on: macos-latest
    # Set timeout yang wajar
    timeout-minutes: 60

    steps:
      - name: Generate VNC Password
        run: |
          password=$(openssl rand -base64 12 | tr -d '/+=' | cut -c1-16)
          echo "VNC_PASSWORD=$password" >> $GITHUB_ENV
          echo "✓ VNC Password: $password"

      - name: Install and Start Tailscale Manually
        run: |
          echo "Installing Tailscale..."
          brew install tailscale
          
          # Lokasi binary tailscaled di macOS runner
          TS_BINARY="/opt/homebrew/opt/tailscale/bin/tailscaled"
          TS_SOCKET="/var/run/tailscale/tailscaled.sock"
          
          echo "Starting Tailscale daemon manually..."
          # Jalankan daemon di latar belakang (Background)
          # Menggunakan sudo dan menentukan lokasi state/socket
          # Buat direktori socket jika belum ada
          sudo mkdir -p $(dirname $TS_SOCKET)
          sudo $TS_BINARY --state=/var/lib/tailscale.state --socket=$TS_SOCKET &
          
          # Tunggu sebentar agar daemon siap
          echo "⏳ Waiting 15 seconds for daemon to start..."
          sleep 15
          
          echo "Connecting to Tailscale..."
          # Gunakan socket path yang sama saat "up"
          sudo tailscale --socket $TS_SOCKET up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=gh-mac-${{ github.run_id }} \
            --accept-routes \
            --timeout=30s
          
          if [ $? -ne 0 ]; then
            echo "❌ Tailscale connection failed. Check logs."
            # Coba hentikan daemon jika gagal
            sudo killall tailscaled 2>/dev/null || true
            exit 1
          fi

          echo "✓ Tailscale connected"

      - name: Get Tailscale IP (Ringkas)
        run: |
          # Beri waktu tunggu lebih lama setelah "tailscale up" selesai.
          # Jika Anda sudah menunggu 15-30 detik di langkah 'up', 5 detik ini cukup.
          sleep 5 
          
          TSIP=$(sudo tailscale ip -4)
          
          if [ -z "$TSIP" ]; then
            echo "❌ Failed to get Tailscale IP"
            echo "Coba kembali ke kode yang menggunakan 'retry loop' jika ini sering gagal."
            exit 1
          fi
          
          echo "TAILSCALE_IP=$TSIP" >> $GITHUB_ENV
          echo "✓ Tailscale IP: $TSIP"


      - name: Setup Virtual Display Driver & Resolution
        run: |
          echo "Configuring system display settings and resolution..."
          
          # Enable display resolution configuration
          sudo defaults write /Library/Preferences/com.apple.windowserver DisplayResolutionEnabled -bool true
          sudo defaults write /Library/Preferences/com.apple.Displays.plist DisplayAnyUserSets -bool true
          
          # Set explicit resolution (contoh: 1920x1080)
          RES="1920x1080"
          sudo defaults write /Library/Preferences/com.apple.windowserver "DisplayResolution" -string "$RES@1"
          
          # Force enable all displays
          sudo defaults write /Library/Preferences/com.apple.Displays AppleDisplay -dict-add "DisplayVendorID" -int 0
          sudo defaults write /Library/Preferences/com.apple.Displays AppleDisplay -dict-add "DisplayProductID" -int 0
          
          echo "✓ Display settings configured to $RES"

      - name: Start GUI Session and Wait
        run: |
          # Kill any existing window server
          sudo killall WindowServer 2>/dev/null || true
          
          # Start WindowServer/Aqua (GUI) for runner user
          echo "Starting GUI session for runner user..."
          # Memulai Finder/Dock memicu WindowServer
          sudo launchctl asuser $(id -u runner) /usr/bin/open -a /System/Library/CoreServices/Finder.app &
          sudo launchctl asuser $(id -u runner) /usr/bin/open -a /System/Library/CoreServices/Dock.app &
          
          # Mencegah tidur/sleep
          sudo pmset -a displaysleep 0 sleep 0
          caffeinate -d -i -s &
          
          # Waktu tunggu yang lebih lama (20 detik) untuk inisialisasi GUI
          echo "⏳ Waiting 20 seconds for GUI to fully initialize..."
          sleep 20
          
          echo "✓ GUI session started"

      - name: Enable VNC Screen Sharing
        run: |
          echo "Configuring VNC..."
          
          # Set VNC password
          printf "%s" "$VNC_PASSWORD" | perl -we 'BEGIN { @k = unpack "C*", pack "H*", "1734516E8BA8C5E2FF1C39567390ADCA"}; $_ = <>; chomp; s/^(.{8}).*/$1/; @p = unpack "C*", $_; foreach (@k) { printf "%02X", $_ ^ (shift @p || 0) }; print "\n"' | sudo tee /Library/Preferences/com.apple.VNCSettings.txt > /dev/null
          
          # Mengaktifkan Remote Management (VNC) dan mengatur izin
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -allowAccessFor -allUsers \
            -configure -access -on \
            -configure -clientopts -setvnclegacy -vnclegacy yes \
            -configure -access -on -privs -all \
            -restart -agent -console
            
          # Memuat ulang layanan Screen Sharing
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true
          
          # Tunggu sebentar setelah aktivasi
          sleep 10
          
          echo "✓ VNC enabled"

      - name: Verify VNC Port
        run: |
          echo "Checking VNC accessibility..."
          netstat -an | grep 5900 || echo "Warning: Port 5900 not listening yet"
          ps aux | grep -i screen || true
          ps aux | grep -i vnc || true

      - name: Display Connection Info & Keep Alive
        run: |
          echo ""
          echo "================================"
          echo "   macOS VNC CONNECTION INFO"
          echo "================================"
          echo "Address: $TAILSCALE_IP:5900"
          echo "Password: $VNC_PASSWORD"
          echo "================================"
          echo ""
          echo "TROUBLESHOOTING LAYAR HITAM:"
          echo "- Tunggu minimal **40-60 detik** setelah langkah ini selesai."
          echo "- Coba putuskan dan sambungkan kembali VNC (disconnect/reconnect)."
          echo "- Cek setelan mode warna (Color Depth) di VNC Viewer Anda (coba setting rendah, misal True Color)."
          echo ""
          
          # Keep everything alive
          while true; do
            echo "[$(date)] macOS VNC Active"
            
            # Keep display awake
            caffeinate -u -t 1 &
            
            # Restart Finder if crashed
            if ! pgrep -x Finder > /dev/null; then
              echo "Restarting Finder..."
              sudo launchctl asuser $(id -u runner) /usr/bin/open -a /System/Library/CoreServices/Finder.app &
            fi
            
            sleep 60 
          done
