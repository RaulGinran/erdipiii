name: macOS Tailscale + macOS VNC + Roblox

on:
  workflow_dispatch:
    inputs:
      ROBLOX_URL:
        description: "Optional: direct URL to Roblox .dmg (otherwise auto)"
        required: false
        default: ""

jobs:
  macos-remote:
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      - name: Print runner info
        shell: bash
        run: |
          sw_vers
          uname -a
          echo "Runner: $RUNNER_NAME / $RUNNER_OS / $RUNNER_ARCH"

      - name: Ensure Homebrew & install Tailscale
        shell: bash
        run: |
          # Ensure brew in PATH
          if ! command -v brew >/dev/null 2>&1; then
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi
          eval "$(/opt/homebrew/bin/brew shellenv 2>/dev/null || true)"
          eval "$(/usr/local/bin/brew shellenv 2>/dev/null || true)"

          brew update
          brew install tailscale || brew upgrade tailscale || true
          command -v tailscale && tailscale version

      - name: Start tailscaled & connect to tailnet
        shell: bash
        env:
          TS_AUTH: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          set -euo pipefail
          if [ -z "${TS_AUTH:-}" ]; then
            echo "Missing secret: TAILSCALE_AUTH_KEY" >&2
            exit 1
          fi

          # Start daemon
          sudo nohup tailscaled --tun=userspace-networking > /tmp/tailscaled.log 2>&1 &

          # Wait daemon up to 20s
          for i in $(seq 1 20); do
            tailscale status >/dev/null 2>&1 && break || sleep 1
          done

          HOST="gha-macos-${GITHUB_RUN_ID}"
          sudo tailscale up --authkey="${TS_AUTH}" --hostname="${HOST}" --accept-routes --accept-dns || \
          sudo tailscale up --authkey="${TS_AUTH}" --hostname="${HOST}"

          ip4="$(tailscale ip -4 | awk '/^ *100\./ {print $1; exit}')"
          if [ -z "$ip4" ]; then
            echo "No Tailscale IPv4 yet"
            tailscale status || true
            tail -n 100 /tmp/tailscaled.log || true
            exit 1
          fi
          echo "TAILSCALE_IP=$ip4" >> "$GITHUB_ENV"
          echo "Tailscale IP: $ip4"

      - name: Create VNC user & enable macOS VNC (Screen Sharing)
        shell: bash
        env:
          VNC_PASS: ${{ secrets.VNC_PASS }}
        run: |
          set -euo pipefail

          if [ -z "${VNC_PASS:-}" ]; then
            echo "Secret VNC_PASS is required (max 8 ASCII chars)." >&2
            exit 1
          fi
          if [ "${#VNC_PASS}" -gt 8 ]; then
            echo "VNC_PASS too long (>8). Apple VNC legacy requires max 8 chars." >&2
            exit 1
          fi

          USER="ghvnc"
          # Create or update user (non-admin)
          if ! id -u "$USER" >/dev/null 2>&1; then
            sudo sysadminctl -addUser "$USER" -fullName "GH VNC User" -password "$VNC_PASS" -home "/Users/$USER"
            sudo createhomedir -c -u "$USER" >/dev/null 2>&1 || true
          else
            sudo dscl . -passwd "/Users/$USER" "$VNC_PASS"
          fi
          sudo chown -R "$USER":staff "/Users/$USER" || true
          echo "VNC_USER=$USER" >> "$GITHUB_ENV"

          KICK="/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart"

          # Activate Remote Management (Screen Sharing) + allow legacy VNC password
          sudo "$KICK" -activate
          sudo "$KICK" -configure -access -on
          sudo "$KICK" -configure -clientopts -setvnclegacy -vnclegacy yes
          # Set VNC password
          sudo "$KICK" -configure -setvncpw -vncpw "$VNC_PASS"
          # Grant privileges to the created user for ARD
          sudo "$KICK" -configure -users "$USER" -privs -all
          # Restart ARD agent
          sudo "$KICK" -restart -agent

          # Enable SSH (optional, handy for troubleshooting)
          sudo systemsetup -setremotelogin on

      - name: Install Roblox (DMG)
        shell: bash
        env:
          ROBLOX_URL_INPUT: ${{ github.event.inputs.ROBLOX_URL }}
        run: |
          set -euo pipefail
          TMP="$(mktemp -d)"
          cd "$TMP"

          # Prefer user-supplied URL; else fetch stable DMG from rbxcdn with fallback
          if [ -n "${ROBLOX_URL_INPUT:-}" ]; then
            URL="$ROBLOX_URL_INPUT"
          else
            # Try versioned endpoint; fallback to generic
            VER_JSON="$(curl -fsS 'https://clientsettings.roblox.com/v2/client-version/MacPlayer' || true)"
            VER="$(echo "$VER_JSON" | grep -Eo 'version-[0-9A-Za-z-]+' | head -n1 || true)"
            if [ -n "$VER" ]; then
              URL="https://setup.rbxcdn.com/mac/${VER}-Roblox.dmg"
            else
              URL="https://setup.rbxcdn.com/Roblox.dmg"
            fi
          fi

          echo "Downloading: $URL"
          curl -fL --retry 5 -o Roblox.dmg "$URL"

          # Mount DMG
          MOUNT="$(hdiutil attach Roblox.dmg -nobrowse -quiet | awk '/Volumes/ {print $3; exit}')"
          if [ -z "$MOUNT" ]; then
            echo "Failed to mount Roblox.dmg" >&2
            exit 1
          fi

          # Install .app or .pkg inside
          if compgen -G "$MOUNT/*.pkg" > /dev/null; then
            PKG="$(ls "$MOUNT"/*.pkg | head -n1)"
            sudo installer -pkg "$PKG" -target /
          elif [ -d "$MOUNT/Roblox.app" ]; then
            sudo cp -R "$MOUNT/Roblox.app" /Applications/
          else
            # try search
            APP="$(find "$MOUNT" -maxdepth 2 -name 'Roblox.app' -type d -print -quit || true)"
            if [ -n "$APP" ]; then
              sudo cp -R "$APP" /Applications/
            else
              echo "Roblox.app/.pkg not found in DMG" >&2
              ls -la "$MOUNT" || true
              hdiutil detach "$MOUNT" -quiet || true
              exit 1
            fi
          fi

          hdiutil detach "$MOUNT" -quiet || true

          if [ -d "/Applications/Roblox.app" ]; then
            echo "Roblox installed at /Applications/Roblox.app"
          else
            echo "Roblox install failed" >&2
            exit 1
          fi

      - name: Print connection info & keep alive
        shell: bash
        timeout-minutes: 360
        run: |
          echo ""
          echo "=== CONNECTION INFO ==="
          echo "Tailscale IP : ${TAILSCALE_IP}"
          echo "VNC address  : ${TAILSCALE_IP}:5900"
          echo "VNC user     : ${VNC_USER}"
          echo "VNC password : (from secret VNC_PASS)"
          echo "Roblox path  : /Applications/Roblox.app"
          echo "tailscaled log: /tmp/tailscaled.log"
          echo "======================="
          echo ""

          while true; do
            date
            tailscale status | head -n 20 || true
            sleep 300
          done
