name: macOS VNC

on:
  workflow_dispatch:

jobs:
  macos-vnc:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Generate VNC Password
        run: |
          # Generate random password (16 characters)
          password=$(openssl rand -base64 12 | tr -d '/+=' | cut -c1-16)
          
          # Store password in environment
          echo "VNC_PASSWORD=$password" >> $GITHUB_ENV
          
          echo "✓ VNC Password generated"

      - name: Install Tailscale
        run: |
          # Install Tailscale via Homebrew (most reliable for GitHub Actions)
          echo "Installing Tailscale via Homebrew..."
          brew install tailscale
          
          # Start tailscaled using brew services (handles socket correctly)
          echo "Starting Tailscale daemon..."
          sudo brew services start tailscale
          
          # Wait for daemon to be ready
          sleep 10
          
          # Verify daemon is running
          if ! pgrep -x tailscaled > /dev/null; then
            echo "❌ Tailscale daemon not running"
            exit 1
          fi
          
          echo "✓ Daemon running"
          
          # Connect to Tailscale network
          echo "Connecting to Tailscale..."
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=gh-mac-${{ github.run_id }} \
            --accept-routes
          
          echo "✓ Tailscale connected successfully"

      - name: Enable VNC Screen Sharing
        run: |
          # Enable auto-login for runner user
          echo "Setting up auto-login..."
          sudo defaults write /Library/Preferences/com.apple.loginwindow autoLoginUser runner
          
          # Enable VNC (Remote Management)
          echo "Enabling VNC..."
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate \
            -configure -allowAccessFor -allUsers \
            -configure -access -on \
            -configure -restart \
            -agent \
            -privs -all
          
          # Enable VNC legacy mode
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvnclegacy -vnclegacy yes
          
          # Set VNC password
          echo "Setting VNC password..."
          mkdir -p ~/Library/Preferences
          printf "%s" "$VNC_PASSWORD" | perl -we 'BEGIN { @k = unpack "C*", pack "H*", "1734516E8BA8C5E2FF1C39567390ADCA"}; $_ = <>; chomp; s/^(.{8}).*/$1/; @p = unpack "C*", $_; foreach (@k) { printf "%02X", $_ ^ (shift @p || 0) }; print "\n"' | sudo tee /Library/Preferences/com.apple.VNCSettings.txt > /dev/null
          
          # Start GUI session for runner user
          echo "Starting GUI session..."
          sudo launchctl asuser $(id -u runner) launchctl load -w /System/Library/LaunchAgents/com.apple.loginwindow.plist 2>/dev/null || true
          
          # Prevent screen sleep
          sudo pmset -a displaysleep 0
          sudo pmset -a sleep 0
          
          # Force wake display
          caffeinate -u -t 5 &
          
          sleep 10
          
          echo "✓ VNC and GUI session enabled"

      - name: Get Tailscale IP
        run: |
          # Wait for Tailscale to get IP
          sleep 5
          
          retries=0
          while [ $retries -lt 20 ]; do
            TSIP=$(sudo tailscale ip -4 2>/dev/null || true)
            if [ ! -z "$TSIP" ]; then
              echo "TAILSCALE_IP=$TSIP" >> $GITHUB_ENV
              echo "✓ Got Tailscale IP: $TSIP"
              break
            fi
            echo "⏳ Waiting for Tailscale IP... attempt $((retries + 1))/20"
            sleep 3
            retries=$((retries + 1))
          done
          
          if [ -z "$TSIP" ]; then
            echo "❌ Failed to get Tailscale IP"
            echo "Tailscale Status:"
            sudo tailscale status
            exit 1
          fi

      - name: Verify VNC Port
        run: |
          echo "Checking VNC port 5900..."
          netstat -an | grep 5900 || echo "VNC port not listening yet"
          
          # Give VNC time to fully start
          sleep 5

      - name: Display Connection Info & Keep Alive
        run: |
          echo ""
          echo "=== VNC ACCESS ==="
          echo "Address: $TAILSCALE_IP:5900"
          echo "Username: runner (or leave blank)"
          echo "Password: $VNC_PASSWORD"
          echo "=================="
          echo ""
          echo "Connect using VNC Viewer to: $TAILSCALE_IP"
          echo "VNC Port: 5900"
          echo ""
          echo "NOTE: If you see black screen, wait 30 seconds for GUI to load"
          echo ""
          
          # Keep display awake and runner active
          while true; do
            echo "[$(date)] macOS VNC Active - Use Ctrl+C in workflow to terminate"
            caffeinate -u -t 1 &
            sleep 300
          done
