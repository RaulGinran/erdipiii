name: macOS VNC

on:
  workflow_dispatch:

jobs:
  macos-vnc:
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      - name: Generate Passwords
        shell: bash
        run: |
          # Password user runner (16) dan VNC password (maks 8 utk legacy VNC)
          RUNNER_PASSWORD="$(openssl rand -base64 24 | tr -d '/+=' | cut -c1-16)"
          VNC_PASSWORD="$(openssl rand -base64 24 | tr -d '/+=' | cut -c1-8)"

          echo "RUNNER_PASSWORD=$RUNNER_PASSWORD" >> "$GITHUB_ENV"
          echo "VNC_PASSWORD=$VNC_PASSWORD" >> "$GITHUB_ENV"

          echo "✓ Runner password generated (16 chars)"
          echo "✓ VNC password generated (8 chars - legacy VNC limit)"

      - name: Install Tailscale
        shell: bash
        run: |
          echo "Installing Tailscale..."
          brew install tailscale

          echo "Starting Tailscale daemon..."
          sudo brew services start tailscale
          sleep 8

          echo "Connecting to Tailscale..."
          # Hindari multi-line dengan backslash (sering error di GA karena whitespace)
          sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" --hostname="gh-mac-${{ github.run_id }}" --accept-routes
          echo "✓ Tailscale connected"

      - name: Get Tailscale IP
        shell: bash
        run: |
          for i in {1..20}; do
            TSIP="$(sudo tailscale ip -4 2>/dev/null | head -n1 || true)"
            if [[ -n "$TSIP" ]]; then
              echo "TAILSCALE_IP=$TSIP" >> "$GITHUB_ENV"
              echo "✓ Tailscale IP: $TSIP"
              exit 0
            fi
            echo "⏳ Waiting for IP... $i/20"
            sleep 3
          done
          echo "❌ Failed to get Tailscale IP"
          exit 1

      - name: Set 'runner' user password (correct dscl syntax)
        shell: bash
        run: |
          echo "Setting password for user 'runner'..."
          # Set langsung (sudo) cukup new password saja
          sudo dscl . -passwd /Users/runner "$RUNNER_PASSWORD"
          # Verifikasi kredensial
          if dscl /Local/Default -authonly runner "$RUNNER_PASSWORD" >/dev/null 2>&1; then
            echo "✓ 'runner' password updated & verified"
          else
            echo "❌ Failed to verify 'runner' password"
            exit 1
          fi

      - name: Enable Remote Management + Legacy VNC
        shell: bash
        run: |
          echo "Activating ARD/Remote Management and enabling legacy VNC..."

          # Izinkan semua user & semua privilese (observe/control, restart, dll)
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate \
            -configure -access -on \
            -configure -allowAccessFor -allUsers -privs -all \
            -configure -clientopts -setvnclegacy -vnclegacy yes \
            -configure -clientopts -setvncpw -vncpw "$VNC_PASSWORD" \
            -restart -agent -console

          # Pastikan ScreenSharing daemon aktif (5900)
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true

          # Sedikit jeda biar agent siap
          sleep 5
          echo "✓ ARD + VNC enabled"

      - name: Verify VNC service
        shell: bash
        run: |
          echo "Checking VNC port..."
          if lsof -nP -iTCP:5900 -sTCP:LISTEN >/dev/null 2>&1; then
            echo "✓ Port 5900 is listening"
          else
            echo "⚠️  Port 5900 not listening yet"
          fi

          echo "Processes:"
          ps aux | egrep -i "ScreenSharing|RemoteManagement|ARDAgent" | grep -v egrep || true

      - name: Display Connection Info & Keep Alive
        shell: bash
        run: |
          echo ""
          echo "================================"
          echo "   macOS VNC CONNECTION INFO"
          echo "================================"
          echo "Address (Tailscale): $TAILSCALE_IP:5900"
          echo "VNC Password       : $VNC_PASSWORD"
          echo "--------------------------------"
          echo "Username (mac login): runner"
          echo "User Password      : $RUNNER_PASSWORD"
          echo "================================"
          echo ""
          echo "Cara konek:"
          echo "- Pakai **VNC password** (tanpa username) di kebanyakan VNC client."
          echo "- Kalau client mendukung Apple Screen Sharing auth (jarang di luar macOS),"
          echo "  kamu bisa coba login pakai user 'runner' + password user."
          echo ""
          echo "Troubleshooting:"
          echo "- Black screen? Tunggu 30–60 detik, reconnect."
          echo "- Pastikan mode auth di VNC client = 'VNC password' (bukan username/password)."
          echo "- Cek port: lsof -nP -iTCP:5900 -sTCP:LISTEN"
          echo "- Restart agent: kickstart -restart -agent -console"
          echo ""

          # Keep alive loop
          while true; do
            echo "[$(date)] macOS VNC Active"
            # Jaga layar tetap bangun
            caffeinate -u -t 2 >/dev/null 2>&1 &
            # Pastikan Finder ada (kadang berguna)
            pgrep -x Finder >/dev/null || sudo launchctl asuser "$(id -u runner)" /usr/bin/open -a /System/Library/CoreServices/Finder.app
            sleep 300
          done
