name: macOS + Tailscale SSH

on:
  workflow_dispatch:

jobs:
  setup-remote:
    # 1. Menggunakan runner macos-latest
    runs-on: macos-latest
    timeout-minutes: 360 # Tahan sampai 6 jam

    steps:
      - name: Install and Connect Tailscale
        shell: bash
        run: |
          echo "Menginstall Tailscale..."
          # 2. Cara install Tailscale di macOS adalah pakai 'brew'
          brew install tailscale
          
          echo "Menjalankan Tailscale service..."
          # 3. Service-nya harus dijalankan di background
          sudo tailscaled &
          
          # Jeda singkat untuk memastikan service siap
          sleep 5 
          
          echo "Menghubungkan ke Tailscale dan mengaktifkan SSH..."
          # 4. Flag --ssh sangat penting
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="gh-runner-macos-$GITHUB_RUN_ID" --accept-routes --ssh
          
          # Ambil IPv4 dengan retry
          echo "Mendapatkan IP Tailscale..."
          tsIP=""
          retries=0
          while [ -z "$tsIP" ] && [ $retries -lt 12 ]; do
            tsIP=$(sudo tailscale ip -4)
            if [ -z "$tsIP" ]; then
              echo "Menunggu IP... (Percobaan $((retries+1)))"
              sleep 5
              retries=$((retries + 1))
            fi
          done

          if [ -z "$tsIP" ]; then
            echo "::error::Gagal mendapatkan IP Tailscale."
            exit 1
          fi
          
          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          
          # 5. User default di runner macOS adalah 'runner'
          echo "SSH_USER=runner" >> $GITHUB_ENV
          echo "Tailscale IP: $tsIP"

      - name: Show connection info & keep alive
        shell: bash
        timeout-minutes: 360 # Sesuaikan dengan timeout job
        run: |
          echo ""
          echo "==================="
          echo "=== SSH ACCESS (TERMINAL) ==="
          echo "Ini HANYA Terminal. JANGAN pakai VNC Viewer."
          echo "Gunakan aplikasi SSH Client (misal: Termius, JuiceSSH)."
          echo ""
          echo "Address  : $TAILSCALE_IP"
          echo "User     : $SSH_USER"
          echo "Password : (Tidak perlu - pakai autentikasi Tailscale)"
          echo "-------------------"
          echo "Perintah : ssh $SSH_USER@$TAILSCALE_IP"
          echo "==================="
          echo ""
          
          # Jaga runner tetap hidup
          while true; do
            echo "[$(date)] SSH Active - Batalkan workflow untuk menghentikan"
            sleep 300
          done
