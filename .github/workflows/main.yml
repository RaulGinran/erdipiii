name: macOS VNC

on:
  workflow_dispatch:

jobs:
  macos-vnc:
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      - name: Generate credentials
        shell: bash
        run: |
          # VNC password max 8 chars (legacy VNC)
          VNC_PASSWORD="$(openssl rand -base64 24 | tr -d '/+=' | cut -c1-8)"
          NEW_ADMIN="ghvnc"
          NEW_ADMIN_PW="$(openssl rand -base64 24 | tr -d '/+=' | cut -c1-16)"
          echo "VNC_PASSWORD=$VNC_PASSWORD" >> "$GITHUB_ENV"
          echo "NEW_ADMIN=$NEW_ADMIN" >> "$GITHUB_ENV"
          echo "NEW_ADMIN_PW=$NEW_ADMIN_PW" >> "$GITHUB_ENV"
          echo "✓ Generated VNC (8) & admin creds (16)"

      - name: Install Tailscale
        shell: bash
        run: |
          brew install tailscale
          sudo brew services start tailscale
          sleep 8
          sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" --hostname="gh-mac-${{ github.run_id }}" --accept-routes
          echo "✓ Tailscale up"

      - name: Get Tailscale IP
        shell: bash
        run: |
          for i in {1..20}; do
            TSIP="$(sudo tailscale ip -4 2>/dev/null | head -n1 || true)"
            if [[ -n "$TSIP" ]]; then
              echo "TAILSCALE_IP=$TSIP" >> "$GITHUB_ENV"
              echo "✓ Tailscale IP: $TSIP"
              exit 0
            fi
            echo "⏳ Waiting for IP... $i/20"
            sleep 3
          done
          echo "❌ Failed to get Tailscale IP"; exit 1

      - name: Create GUI admin (no change to 'runner')
        shell: bash
        run: |
          echo "Creating admin user: $NEW_ADMIN"
          sudo sysadminctl -addUser "$NEW_ADMIN" -password "$NEW_ADMIN_PW" -admin -home "/Users/$NEW_ADMIN" -UID 599 || {
            echo "Note: user may already exist, continuing…"
          }
          dscl . -read "/Users/$NEW_ADMIN" >/dev/null && echo "✓ Admin ready"

      - name: Enable Remote Management + Legacy VNC
        shell: bash
        run: |
          echo "Enabling ARD + legacy VNC"
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate \
            -configure -access -on \
            -configure -allowAccessFor -allUsers -privs -all \
            -configure -clientopts -setvnclegacy -vnclegacy yes \
            -configure -clientopts -setvncpw -vncpw "$VNC_PASSWORD" \
            -restart -agent -console
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true
          sleep 5
          echo "✓ ARD + VNC enabled"

      - name: Verify VNC service
        shell: bash
        run: |
          if lsof -nP -iTCP:5900 -sTCP:LISTEN >/dev/null 2>&1; then
            echo "✓ Port 5900 listening"
          else
            echo "⚠️  Port 5900 not listening (yet)"
          fi
          ps aux | egrep -i "ScreenSharing|RemoteManagement|ARDAgent" | grep -v egrep || true

      - name: Connection Info & Keep Alive
        shell: bash
        run: |
          cat <<EOF

================================
   macOS VNC CONNECTION INFO
================================
Address (Tailscale): $TAILSCALE_IP:5900
VNC Password       : $VNC_PASSWORD   (use 'VNC password' mode)
--------------------------------
macOS GUI login user : $NEW_ADMIN
macOS GUI password   : $NEW_ADMIN_PW
================================

Cara pakai:
1) VNC client → connect ke $TAILSCALE_IP:5900 → masukkan VNC password (bukan user/pass).
2) Setelah masuk, kalau lihat login window, login pakai user $NEW_ADMIN + password di atas.

Troubleshooting:
- Black screen? Tunggu 30–60 detik dan reconnect.
- Pastikan auth mode di VNC client = "VNC password".
- Cek port: lsof -nP -iTCP:5900 -sTCP:LISTEN
- Restart ARD agent: kickstart -restart -agent -console
EOF

          while true; do
            echo "[$(date)] macOS VNC Active"
            caffeinate -u -t 2 >/dev/null 2>&1 &
            pgrep -x Finder >/dev/null || sudo launchctl asuser "$(id -u $NEW_ADMIN)" /usr/bin/open -a /System/Library/CoreServices/Finder.app
            sleep 300
          done
