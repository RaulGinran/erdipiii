name: VNC + Tailscale + StarDesk (macOS)

on:
  workflow_dispatch:

jobs:
  setup-remote:
    runs-on: macos-latest   # bisa ubah ke macos-14, macos-13, dst.
    timeout-minutes: 360

    steps:
      - name: Enable Screen Sharing (VNC)
        shell: bash
        run: |
          echo "Mengaktifkan VNC access..."
          sudo systemsetup -setremotelogin on
          sudo defaults write /Library/Preferences/com.apple.RemoteManagement.plist VNCAlwaysStartOnConsole -bool true
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw Asukoe123456 \
            -restart -agent -privs -all

          echo "VNC password diset ke: Asukoe123456"

      - name: Install Tailscale
        shell: bash
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=macos-runner-${GITHUB_RUN_ID}
          sleep 10
          tailscale ip -4 | tee tailscale_ip.txt
          echo "TAILSCALE_IP=$(cat tailscale_ip.txt)" >> $GITHUB_ENV

      - name: Install StarDesk
        shell: bash
        run: |
          mkdir -p ~/Downloads/stardesk
          cd ~/Downloads/stardesk
          curl -L -o StarDesk_1.0.1.dmg "https://dl.stardesk.net/StarDesk_Setup_V1.0.1.5404_0926024227_stardesk_nochannel.exe?n=StarDesk_1.0.1.exe"
          echo "StarDesk DMG downloaded."
          # kalau nanti StarDesk ada versi DMG/macOS resmi, ganti URL di atas

      - name: Show connection info & keep alive
        shell: bash
        run: |
          echo ""
          echo "=== VNC ACCESS ==="
          echo "Address : $TAILSCALE_IP"
          echo "Password: Asukoe123456"
          echo "=================="
          echo ""
          echo "Connect via VNC app (RealVNC, Remmina, atau Android VNC Viewer)"
          echo "contoh address: vnc://$TAILSCALE_IP"
          while true; do
            echo "[$(date)] VNC aktif - tekan Cancel workflow untuk stop"
            sleep 300
          done
