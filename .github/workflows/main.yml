name: VNC + Tailscale (macOS, robust)

on:
  workflow_dispatch:

jobs:
  setup-remote:
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      - name: Enable Screen Sharing (VNC)
        shell: bash
        run: |
          echo "== Enable VNC / Remote Management =="
          sudo systemsetup -setremotelogin on || true
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw Asukoe123456 \
            -restart -agent -privs -all
          echo "VNC password: Asukoe123456"
          echo

      - name: Install latest Tailscale .pkg (not App Store)
        shell: bash
        run: |
          set -euo pipefail
          STABLE_INDEX="https://pkgs.tailscale.com/stable/"
          echo "== Resolve latest Tailscale macOS pkg from index =="
          PKG_NAME="$(curl -fsSL "$STABLE_INDEX" | grep -o 'Tailscale-[0-9.]*-macos\.pkg' | sort -Vr | head -n1)"
          if [[ -z "${PKG_NAME:-}" ]]; then
            echo "ERROR: gagal menemukan nama pkg Tailscale di index."
            exit 1
          fi
          URL="${STABLE_INDEX}${PKG_NAME}"
          echo "Downloading ${URL} ..."
          curl -fsSL -o "${PKG_NAME}" "${URL}"

          echo "Installing ${PKG_NAME} ..."
          sudo installer -pkg "${PKG_NAME}" -target /

          TS_APP="/Applications/Tailscale.app"
          TS_BIN="${TS_APP}/Contents/MacOS/Tailscale"
          if [[ ! -x "$TS_BIN" ]]; then
            echo "ERROR: Tailscale binary tidak ditemukan di ${TS_BIN}"
            exit 1
          fi
          echo "TS_BIN=${TS_BIN}" >> "$GITHUB_ENV"
          echo

      - name: Launch Tailscale app & prepare daemon
        shell: bash
        run: |
          set -euo pipefail
          TS_BIN="${TS_BIN:-/Applications/Tailscale.app/Contents/MacOS/Tailscale}"
          TS_APP="/Applications/Tailscale.app"

          echo "== Launch Tailscale app (to register Network Extension) =="
          open -a "$TS_APP" || true
          # Beri waktu sedikit supaya helper/daemon kebangun
          sleep 5
          # Pastikan versi kebaca
          "$TS_BIN" version || true
          echo

      - name: Bring up Tailscale (unattended, timeout, verbose)
        shell: bash
        run: |
          set -euo pipefail
          TS_BIN="${TS_BIN:-/Applications/Tailscale.app/Contents/MacOS/Tailscale}"
          HOST="macos-runner-${GITHUB_RUN_ID}"

          echo "== Tailscale up (unattended) =="
          # --unattended: jangan minta GUI login; HARUS pakai auth key yang preauthorized/ephemeral.
          # --timeout: kalau lama, jangan ngegantung.
          sudo "$TS_BIN" up \
            --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" \
            --hostname="${HOST}" \
            --unattended \
            --accept-dns=false \
            --accept-routes=false \
            --ssh \
            --timeout=60s || {
              echo "tailscale up gagal/timeout."
              echo "-- status --"; sudo "$TS_BIN" status || true
              echo "-- netcheck --"; sudo "$TS_BIN" netcheck || true
              echo "Kemungkinan: auth key butuh approval / expired / tidak preauthorized."
              exit 1
            }

          echo
          echo "== Polling for Tailscale IPv4 (up to ~3 minutes) =="
          tries=0
          TS_IP=""
          while [[ $tries -lt 36 ]]; do
            TS_IP="$(sudo "$TS_BIN" ip -4 | head -n1 || true)"
            if [[ -n "$TS_IP" ]]; then
              echo "Tailscale IP acquired: ${TS_IP}"
              break
            fi
            tries=$((tries+1))
            echo "No IP yet... (${tries}/36) waiting 5s"
            sleep 5
          done

          if [[ -z "$TS_IP" ]]; then
            echo "ERROR: Tidak dapat IP Tailscale dalam 3 menit."
            echo "Cek:"
            echo " - secrets.TAILSCALE_AUTH_KEY valid, belum expired"
            echo " - Auth key di-set 'Reusable' atau 'Ephemeral' + 'Preauthorized' (NO admin approval)"
            echo " - Tailnet policy tidak mewajibkan SSO/GUI approval"
            echo "-- status --"; sudo "$TS_BIN" status || true
            echo "-- netcheck --"; sudo "$TS_BIN" netcheck || true
            exit 1
          fi

          echo "TAILSCALE_IP=${TS_IP}" >> "$GITHUB_ENV"
          echo
          echo "== Quick status =="
          sudo "$TS_BIN" status || true
          echo

      - name: Verify VNC port (5900) is listening
        shell: bash
        run: |
          echo "== Check VNC listen on 5900 =="
          (sudo lsof -nP -iTCP:5900 -sTCP:LISTEN || true)
          echo "Done."
          echo

      - name: Show connection info & keep alive
        shell: bash
        timeout-minutes: 360
        run: |
          echo ""
          echo "=== VNC ACCESS ==="
          echo "Address : $TAILSCALE_IP"
          echo "Password: Asukoe123456"
          echo "=================="
          echo ""
          echo "Android: pakai VNC Viewer/bVNC, connect ke $TAILSCALE_IP:5900"
          echo ""
          while true; do
            echo "[$(date)] VNC aktif - Cancel workflow untuk stop"
            sleep 300
          done
