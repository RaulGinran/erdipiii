name: RDP + Tailscale + XFCE (runner)

on:
  workflow_dispatch:

jobs:
  setup-remote:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # Tahan sampai 6 jam

    steps:
      - name: Install XFCE, XRDP, and Chrome
        shell: bash
        run: |
          echo "Memulai update dan instalasi..."
          sudo apt-get update
          
          # Install XFCE (Desktop Environment)
          echo "Menginstall XFCE..."
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y xfce4 xfce4-goodies
          
          # Install XRDP (RDP Server)
          echo "Menginstall XRDP..."
          sudo apt-get install -y xrdp
          
          # Install Google Chrome
          echo "Menginstall Google Chrome..."
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          
          echo "Instalasi software selesai."

      - name: Configure XRDP and Set Password
        shell: bash
        run: |
          # Konfigurasi XRDP untuk menggunakan XFCE
          echo "xfce4-session" > ~/.xsession
          sudo sed -i 's/test -x \/etc\/X11\/Xsession/exec \/bin\/bash \/etc\/X11\/Xsession/' /etc/xrdp/startwm.sh
          
          # Restart XRDP service
          echo "Merestart service XRDP..."
          sudo systemctl restart xrdp
          
          # Set password untuk user 'runner' (user default di GitHub Actions)
          # --- INI BAGIAN YANG DIPERBAIKI (sintaks Bash) ---
          user="runner"
          pass="Asukoe123456" # <- Password basic
          
          echo "Mengatur password untuk user $user..."
          echo "$user:$pass" | sudo chpasswd
          
          echo "RDP_USER=$user" >> $GITHUB_ENV
          echo "RDP_PASS=$pass" >> $GITHUB_ENV
          echo "Konfigurasi user dan password selesai."

      - name: Install and Connect Tailscale
        shell: bash
        run: |
          echo "Menginstall Tailscale..."
          curl -fsSL https://tailscale.com/install.sh | sudo sh
          
          echo "Menghubungkan ke Tailscale..."
          # Gunakan --accept-routes untuk fungsionalitas penuh (opsional tapi disarankan)
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="gh-runner-$GITHUB_RUN_ID" --accept-routes
          
          # Ambil IPv4 dengan retry
          echo "Mendapatkan IP Tailscale..."
          tsIP=""
          retries=0
          while [ -z "$tsIP" ] && [ $retries -lt 12 ]; do
            tsIP=$(sudo tailscale ip -4)
            if [ -z "$tsIP" ]; then
              echo "Menunggu IP... (Percobaan $((retries+1)))"
              sleep 5
              retries=$((retries + 1))
            fi
          done

          if [ -z "$tsIP" ]; then
            echo "::error::Gagal mendapatkan IP Tailscale."
            exit 1
          fi
          
          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          echo "Tailscale IP: $tsIP"

      - name: Verify RDP port listening
        shell: bash
        run: |
          echo "Memverifikasi port RDP 3389..."
          # ss (socket statistics) adalah pengganti netstat di Linux modern
          if ! ss -ltn | grep -q 3389; then
            echo "::error::Port RDP 3389 tidak 'listen'."
            sudo systemctl status xrdp
            exit 1
          fi
          echo "Verifikasi RDP 3389 berhasil. Service 'listen'."

      - name: Show connection info & keep alive
        shell: bash
        timeout-minutes: 360 # Sesuaikan dengan timeout job
        run: |
          echo ""
          echo "==================="
          echo "=== RDP ACCESS ==="
          echo "Address  : $TAILSCALE_IP"
          echo "Username : $RDP_USER"
          echo "Password : $RDP_PASS"
          echo "==================="
          echo ""
          
          # Jaga runner tetap hidup
          while true; do
            echo "[$(date)] RDP Active - Batalkan workflow untuk menghentikan"
            sleep 300
          done
