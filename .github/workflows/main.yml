name: macOS VNC

on:
  workflow_dispatch:

jobs:
  macos-vnc:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Generate VNC Password
        run: |
          password=$(openssl rand -base64 12 | tr -d '/+=' | cut -c1-16)
          echo "VNC_PASSWORD=$password" >> $GITHUB_ENV
          echo "✓ VNC Password: $password"

      - name: Install Tailscale
        run: |
          echo "Installing Tailscale..."
          brew install tailscale
          
          echo "Starting Tailscale daemon..."
          sudo brew services start tailscale
          sleep 10
          
          echo "Connecting to Tailscale..."
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=gh-mac-${{ github.run_id }} \
            --accept-routes
          
          echo "✓ Tailscale connected"

      - name: Get Tailscale IP
        run: |
          sleep 5
          retries=0
          while [ $retries -lt 20 ]; do
            TSIP=$(sudo tailscale ip -4 2>/dev/null || true)
            if [ ! -z "$TSIP" ]; then
              echo "TAILSCALE_IP=$TSIP" >> $GITHUB_ENV
              echo "✓ Tailscale IP: $TSIP"
              break
            fi
            echo "⏳ Waiting for IP... $((retries + 1))/20"
            sleep 3
            retries=$((retries + 1))
          done
          
          if [ -z "$TSIP" ]; then
            echo "❌ Failed to get Tailscale IP"
            exit 1
          fi

      - name: Setup GUI, VNC, and Force Login
        run: |
          echo "Setting password for runner user..."
          
          # PERBAIKAN: Gunakan 'changepassword' dan asumsikan password lama kosong ("")
          # Ini menghindari prompt interaktif yang menyebabkan error eDSAuthFailed
          sudo dscl . -changepassword /Users/runner "" "$VNC_PASSWORD"
          
          echo "Configuring VNC password..."
          # Ini script perl dari workflow-mu untuk set password VNC
          printf "%s" "$VNC_PASSWORD" | perl -we 'BEGIN { @k = unpack "C*", pack "H*", "1734516E8BA8C5E2FF1C39567390ADCA"}; $_ = <>; chomp; s/^(.{8}).*/$1/; @p = unpack "C*", $_; foreach (@k) { printf "%02X", $_ ^ (shift @p || 0) }; print "\n"' | sudo tee /Library/Preferences/com.apple.VNCSettings.txt > /dev/null
          
          echo "Activating ARD/VNC and forcing GUI login..."
          # Perintah kickstart tetap sama, tapi sekarang akan berhasil karena password user-nya sudah di-set
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate \
            -configure -allowAccessFor -allUsers \
            -configure -access -on \
            -configure -privs -all \
            -configure -clientopts -setvnclegacy -vnclegacy yes \
            -restart -agent -console \
            -login -name runner -password "$VNC_PASSWORD"
          
          # Pastikan service-nya berjalan
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true
          
          echo "✓ VNC setup and GUI login initiated."
          echo "Waiting 15s for GUI session to stabilize..."
          sleep 15

      - name: Verify VNC Port
        run: |
          echo "Checking VNC accessibility..."
          netstat -an | grep 5900 || echo "Warning: Port 5900 not listening yet"
          ps aux | grep -i screen || true
          ps aux | grep -i vnc || true

      - name: Display Connection Info & Keep Alive
        run: |
          echo ""
          echo "================================"
          echo "   macOS VNC CONNECTION INFO"
          echo "================================"
          echo "Address: $TAILSCALE_IP:5900"
          echo "Password: $VNC_PASSWORD"
          echo "================================"
          echo ""
          echo "TROUBLESHOOTING:"
          echo "- If black screen: Wait 30-60 seconds"
          echo "- Try disconnect/reconnect"
          echo "- Check VNC Viewer color mode settings"
          echo ""
          
          # Keep everything alive
          while true; do
            echo "[$(date)] macOS VNC Active"
            
            # Keep display awake
            caffeinate -u -t 1 &
            
            # Restart Finder if crashed
            if ! pgrep -x Finder > /dev/null; then
              echo "Restarting Finder..."
              sudo launchctl asuser $(id -u runner) /usr/bin/open -a /System/Library/CoreServices/Finder.app &
            fi
            
            sleep 300
          done
