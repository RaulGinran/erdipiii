name: macOS Tailscale + TigerVNC (virtual desktop)

on:
  workflow_dispatch:
    inputs:
      VNC_PASS:
        description: "Opsional: VNC password (kalau kosong, akan di-generate & ditampilkan)"
        required: false
        default: ""
      GEOMETRY:
        description: "Resolusi VNC (mis. 1920x1080)"
        required: false
        default: "1920x1080"

jobs:
  macos-remote:
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      - name: Info runner
        shell: bash
        run: |
          sw_vers
          whoami
          echo "HOME=$HOME"

      - name: Install Tailscale + TigerVNC + fluxbox + xterm
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v brew >/dev/null 2>&1; then
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi
          eval "$(/opt/homebrew/bin/brew shellenv 2>/dev/null || true)"
          eval "$(/usr/local/bin/brew shellenv 2>/dev/null || true)"
          brew update
          brew install tailscale tiger-vnc fluxbox xterm || brew upgrade tailscale tiger-vnc fluxbox xterm || true
          command -v tailscale && tailscale version || true
          command -v vncserver || true

      - name: Start tailscaled & connect
        shell: bash
        env:
          TS_AUTH: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          set -euo pipefail
          if [ -z "${TS_AUTH:-}" ]; then
            echo "Missing secret: TAILSCALE_AUTH_KEY" >&2
            exit 1
          fi
          sudo nohup tailscaled --tun=userspace-networking > /tmp/tailscaled.log 2>&1 &

          for i in $(seq 1 20); do
            tailscale status >/dev/null 2>&1 && break || sleep 1
          done

          HOST="gha-macos-${GITHUB_RUN_ID}"
          sudo tailscale up --authkey="${TS_AUTH}" --hostname="${HOST}" --accept-routes --accept-dns || \
          sudo tailscale up --authkey="${TS_AUTH}" --hostname="${HOST}"

          ip4="$(tailscale ip -4 | awk '/^ *100\./{print $1;exit}')"
          if [ -z "$ip4" ]; then
            echo "No Tailscale IPv4 yet"
            tailscale status || true
            tail -n 100 /tmp/tailscaled.log || true
            exit 1
          fi
          echo "TAILSCALE_IP=$ip4" >> "$GITHUB_ENV"
          echo "Tailscale IP: $ip4"

      - name: Configure TigerVNC & launch
        shell: bash
        env:
          VNC_PASS_INPUT: ${{ github.event.inputs.VNC_PASS }}
          GEOM: ${{ github.event.inputs.GEOMETRY }}
        run: |
          set -euo pipefail

          # password: pakai input kalau ada; kalau kosong generate 8 char & tampilkan
          if [ -n "${VNC_PASS_INPUT:-}" ]; then
            VNC_PASS="$VNC_PASS_INPUT"
          else
            VNC_PASS="$(LC_ALL=C tr -dc 'A-Za-z0-9' </dev/urandom | head -c8)"
            echo "::notice::Generated VNC password: ${VNC_PASS}"
          fi
          echo "VNC_PASS=$VNC_PASS" >> "$GITHUB_ENV"

          mkdir -p "$HOME/.vnc"

          # tulis passwd (terenkripsi) tanpa heredoc
          if command -v vncpasswd >/dev/null 2>&1; then
            printf "%s\n" "$VNC_PASS" | vncpasswd -f > "$HOME/.vnc/passwd"
          else
            printf "%s\n" "$VNC_PASS" | /opt/homebrew/bin/vncpasswd -f > "$HOME/.vnc/passwd"
          fi
          chmod 600 "$HOME/.vnc/passwd"

          # xstartup minimal via printf (hindari heredoc/char aneh)
          printf '%s\n' \
            '#!/bin/sh' \
            'export PATH="/opt/homebrew/bin:/usr/local/bin:$PATH"' \
            'export LANG=en_US.UTF-8' \
            'fluxbox &' \
            'xterm &' \
            > "$HOME/.vnc/xstartup"
          chmod +x "$HOME/.vnc/xstartup"

          # kill yang lama, lalu start lagi
          vncserver -kill :1 >/dev/null 2>&1 || true
          pkill Xvnc || true

          GEOM="${GEOM:-1920x1080}"
          nohup vncserver :1 -geometry "$GEOM" -rfbport 5900 > /tmp/vncserver.log 2>&1 &

          sleep 2
          echo "===== /tmp/vncserver.log ====="
          tail -n +1 /tmp/vncserver.log || true
          echo "=============================="

          echo "VNC_PORT=5900" >> "$GITHUB_ENV"

      - name: Connection info & keep alive
        shell: bash
        timeout-minutes: 360
        run: |
          echo ""
          echo "=== CONNECTION INFO (TigerVNC X11) ==="
          echo "Tailscale IP : ${TAILSCALE_IP}"
          echo "VNC address  : ${TAILSCALE_IP}:5900"
          echo "VNC password : ${VNC_PASS}"
          echo "Geometry     : ${GEOMETRY:-1920x1080}"
          echo "Log files    : /tmp/tailscaled.log , /tmp/vncserver.log"
          echo "======================================"
          echo ""
          while true; do
            date
            tailscale status | head -n 20 || true
            ps aux | egrep 'vncserver|Xvnc|Xtigervnc' | egrep -v egrep || true
            sleep 300
          done
