name: macOS VNC

on:
  workflow_dispatch:

jobs:
  macos-vnc:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Generate VNC Password
        run: |
          # Generate random password
          password=$(openssl rand -base64 12 | tr -d '/+=' | cut -c1-16)
          
          # Store password
          echo "VNC_CREDS=User: runner | Password: $password" >> $GITHUB_ENV
          echo "VNC_PASSWORD=$password" >> $GITHUB_ENV
          
          echo "Generated VNC Password successfully"

      - name: Install Tailscale
        run: |
          # Download Tailscale for macOS (using direct pkg link)
          curl -L -o /tmp/Tailscale.pkg "https://pkgs.tailscale.com/stable/Tailscale-1.82.0-macos.pkg"
          
          # Install Tailscale
          sudo installer -pkg /tmp/Tailscale.pkg -target /
          
          # Wait for installation to complete
          sleep 5
          
          # Start Tailscale
          open -a Tailscale
          sleep 5
          
          # Connect to Tailscale
          /Applications/Tailscale.app/Contents/MacOS/Tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-mac-${{ github.run_id }} --accept-routes

      - name: Enable VNC Screen Sharing
        run: |
          # Set VNC password using perl (most reliable method)
          printf "%s" "$VNC_PASSWORD" | perl -we 'BEGIN { @k = unpack "C*", pack "H*", "1734516E8BA8C5E2FF1C39567390ADCA"}; $_ = <>; chomp; s/^(.{8}).*/$1/; @p = unpack "C*", $_; foreach (@k) { printf "%02X", $_ ^ (shift @p || 0) }; print "\n"' | sudo tee /Library/Preferences/com.apple.VNCSettings.txt > /dev/null
          
          # Enable Remote Management (ARD/VNC)
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate \
            -configure -allowAccessFor -allUsers \
            -configure -access -on \
            -configure -restart \
            -agent \
            -privs -all
          
          # Enable VNC for all users
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvnclegacy -vnclegacy yes
          
          # Enable Screen Sharing service
          sudo launchctl enable system/com.apple.screensharing
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true
          
          # Alternative: direct systemsetup method
          echo "$VNC_PASSWORD" | sudo tee /tmp/vncpass > /dev/null
          sudo /usr/bin/vncpasswd -legacy -storepasswd /tmp/vncpass /Library/Preferences/com.apple.VNCSettings.txt 2>/dev/null || true
          sudo rm -f /tmp/vncpass
          
          # Restart services
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -restart -agent -console
          sudo killall ARDAgent 2>/dev/null || true
          
          sleep 5

      - name: Get Tailscale IP
        run: |
          # Wait for Tailscale to get IP
          sleep 10
          
          retries=0
          while [ $retries -lt 10 ]; do
            TSIP=$(/Applications/Tailscale.app/Contents/MacOS/Tailscale ip -4 2>/dev/null)
            if [ ! -z "$TSIP" ]; then
              echo "TAILSCALE_IP=$TSIP" >> $GITHUB_ENV
              break
            fi
            sleep 5
            retries=$((retries + 1))
          done
          
          if [ -z "$TSIP" ]; then
            echo "Failed to get Tailscale IP"
            exit 1
          fi

      - name: Verify VNC Port
        run: |
          echo "Checking VNC port 5900..."
          netstat -an | grep 5900 || echo "VNC port not listening yet"
          
          # Give VNC time to fully start
          sleep 5

      - name: Display Connection Info & Keep Alive
        run: |
          echo ""
          echo "=== VNC ACCESS ==="
          echo "Address: $TAILSCALE_IP:5900"
          echo "Username: runner (or leave blank)"
          echo "Password: $VNC_PASSWORD"
          echo "=================="
          echo ""
          echo "Connect using VNC Viewer to: $TAILSCALE_IP"
          echo "VNC Port: 5900"
          echo ""
          
          # Keep runner active
          while true; do
            echo "[$(date)] macOS VNC Active - Use Ctrl+C in workflow to terminate"
            sleep 300
          done
