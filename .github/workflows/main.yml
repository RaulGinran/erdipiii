name: macOS VNC

on:
  workflow_dispatch:

jobs:
  macos-vnc:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Create VNC User with Secure Password
        run: |
          # Generate random password (same method as Windows script)
          password=$(LC_ALL=C tr -dc 'A-Za-z0-9!@#$%^&*()_+=' < /dev/urandom | head -c 16)
          
          # Create user Yanzz
          sudo dscl . -create /Users/Yanzz
          sudo dscl . -create /Users/Yanzz UserShell /bin/bash
          sudo dscl . -create /Users/Yanzz RealName "Yanzz"
          sudo dscl . -create /Users/Yanzz UniqueID 1001
          sudo dscl . -create /Users/Yanzz PrimaryGroupID 80
          sudo dscl . -create /Users/Yanzz NFSHomeDirectory /Users/Yanzz
          
          # Set password
          sudo dscl . -passwd /Users/Yanzz "$password"
          
          # Add to admin group
          sudo dscl . -append /Groups/admin GroupMembership Yanzz
          
          # Create home directory
          sudo createhomedir -c -u Yanzz
          
          echo "VNC_CREDS=User: Yanzz | Password: $password" >> $GITHUB_ENV
          echo "VNC_PASSWORD=$password" >> $GITHUB_ENV

      - name: Install Tailscale
        run: |
          # Download and install Tailscale
          curl -o /tmp/tailscale.zip https://pkgs.tailscale.com/stable/tailscale_1.82.0_amd64.zip
          unzip /tmp/tailscale.zip -d /tmp/
          sudo installer -pkg /tmp/Tailscale.pkg -target /
          
          # Start Tailscale daemon
          sudo /Applications/Tailscale.app/Contents/MacOS/Tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-mac-${{ github.run_id }}

      - name: Enable VNC Screen Sharing
        run: |
          # Enable Remote Management (VNC)
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate \
            -configure -allowAccessFor -allUsers \
            -configure -restart \
            -agent \
            -privs -all
          
          # Configure VNC authentication
          sudo defaults write /Library/Preferences/com.apple.RemoteManagement VNCLegacyConnectionsEnabled -bool true
          
          # Set VNC password using the generated password
          echo "$VNC_PASSWORD" | sudo /usr/bin/vncpasswd -storepasswd /Library/Preferences/com.apple.VNCSettings.txt
          
          # Enable Screen Sharing
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true
          
          # Restart ARD Agent
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -restart -agent

      - name: Get Tailscale IP
        run: |
          # Wait for Tailscale to get IP
          sleep 10
          
          retries=0
          while [ $retries -lt 10 ]; do
            TSIP=$(/Applications/Tailscale.app/Contents/MacOS/Tailscale ip -4 2>/dev/null)
            if [ ! -z "$TSIP" ]; then
              echo "TAILSCALE_IP=$TSIP" >> $GITHUB_ENV
              break
            fi
            sleep 5
            retries=$((retries + 1))
          done
          
          if [ -z "$TSIP" ]; then
            echo "Failed to get Tailscale IP"
            exit 1
          fi

      - name: Verify VNC Port
        run: |
          echo "Checking VNC port 5900..."
          netstat -an | grep 5900 || echo "VNC port not listening yet"
          
          # Give VNC time to fully start
          sleep 5

      - name: Display Connection Info & Keep Alive
        run: |
          echo ""
          echo "=== VNC ACCESS ==="
          echo "Address: $TAILSCALE_IP:5900"
          echo "Username: Yanzz"
          echo "Password: $VNC_PASSWORD"
          echo "=================="
          echo ""
          echo "Connect using VNC Viewer to: $TAILSCALE_IP"
          echo ""
          
          # Keep runner active
          while true; do
            echo "[$(date)] macOS VNC Active - Use Ctrl+C in workflow to terminate"
            sleep 300
          done
