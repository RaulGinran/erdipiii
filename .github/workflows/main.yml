name: RDP + Tailscale (Ubuntu)

on:
  workflow_dispatch:

jobs:
  setup-remote:
    runs-on: ubuntu-latest
    timeout-minutes: 360   # tahan sampai ~6 jam

    steps:
      - name: Update apt & basic tools
        shell: bash
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y curl wget gnupg lsof net-tools

      - name: Create user 'runneradmin' (samain user/pw) & prep home
        shell: bash
        run: |
          set -euxo pipefail
          USERNAME="runneradmin"
          PASSWORD="Asukoe123456"   # <- samain; disarankan pakai secret nantinya
          if ! id -u "$USERNAME" >/dev/null 2>&1; then
            sudo useradd -m -s /bin/bash "$USERNAME"
          fi
          echo "${USERNAME}:${PASSWORD}" | sudo chpasswd
          sudo usermod -aG sudo "$USERNAME"

          # simpan env untuk ditampilkan nanti
          echo "RDP_USER=$USERNAME" >> "$GITHUB_ENV"
          echo "RDP_PASS=$PASSWORD" >> "$GITHUB_ENV"

      - name: Install desktop (XFCE) + xrdp
        shell: bash
        run: |
          set -euxo pipefail
          # XFCE jauh lebih ringan dibanding ubuntu-desktop
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y xfce4 xfce4-goodies xorg dbus-x11 x11-xserver-utils
          sudo apt-get install -y xrdp
          # xrdp butuh akses ke cert
          sudo adduser xrdp ssl-cert || true
          # Pakai XFCE untuk sesi RDP
          for u in "$RDP_USER" "runner"; do
            if id "$u" >/dev/null 2>&1; then
              sudo -u "$u" bash -lc 'echo "startxfce4" > ~/.xsession'
            fi
          done
          # Enable & start xrdp
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp

      - name: (Optional) Restrict RDP to Tailscale only (no UFW by default)
        shell: bash
        run: |
          set -euxo pipefail
          # GitHub ubuntu runners biasanya tidak mengaktifkan UFW, jadi port 3389 terbuka.
          # Kalau mau lebih aman, aktifkan UFW & izinkan hanya dari subnet Tailscale (100.64.0.0/10).
          # sudo apt-get install -y ufw
          # sudo ufw allow from 100.64.0.0/10 to any port 3389 proto tcp
          # sudo ufw --force enable
          true

      - name: Install Tailscale
        shell: bash
        run: |
          set -euxo pipefail
          curl -fsSL https://tailscale.com/install.sh | sh
          tailscale --version || true

      - name: Connect Tailscale
        shell: bash
        env:
          TS_AUTHKEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          set -euxo pipefail
          sudo tailscale up --authkey="${TS_AUTHKEY}" --hostname="gh-ubuntu-${GITHUB_RUN_ID}"
          # Ambil IPv4 Tailscale
          TS_IP="$(tailscale ip -4 | head -n1 || true)"
          if [ -z "$TS_IP" ]; then
            echo "Gagal mengambil IPv4 Tailscale"; exit 1
          fi
          echo "TAILSCALE_IP=$TS_IP" >> "$GITHUB_ENV"
          echo "Tailscale IP: $TS_IP"

      - name: Verify RDP port via Tailscale
        shell: bash
        run: |
          set -euxo pipefail
          TS_IP="$TAILSCALE_IP"
          echo "Testing TCP 3389 on $TS_IP ..."
          # Coba connect ke port 3389 (xrdp) via bash /dev/tcp
          timeout 5 bash -lc "exec 3<>/dev/tcp/${TS_IP}/3389" && echo "RDP 3389 reachable." || (echo "RDP 3389 not reachable" && exit 1)

      - name: Show connection info & keep alive
        shell: bash
        timeout-minutes: 360
        run: |
          set -euxo pipefail
          echo
          echo "=== RDP ACCESS (Ubuntu) ==="
          echo "Address : ${TAILSCALE_IP}"
          echo "Username: ${RDP_USER}"
          echo "Password: ${RDP_PASS}"
          echo "==========================="
          echo

          echo "Listening sockets (grep 3389):"
          sudo ss -tulpn | (grep 3389 || true) || true
          echo

          # Keep runner hidup (CTRL+C / cancel job untuk stop)
          while true; do
            echo "[$(date)] RDP Active - cancel workflow to terminate"
            sleep 300
          done
